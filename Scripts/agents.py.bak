from typing import List, Dict, Optional
from model_handler import ModelHandler
from prompts import AgentPrompts
from config import Config
from utils import extract_json_from_response
from document_handler import DocumentHandler
from customer_profile_manager import CustomerProfileManager, get_customer_aware_prompt
from check_order_handler import OrderDataHandler, CHECK_ORDER_PROMPT
import logging

logger = logging.getLogger(__name__)


class AgentService:
    """
    Service qu·∫£n l√Ω c√°c agents v·ªõi t√≠nh nƒÉng m·ªü r·ªông.
    """

    def __init__(
            self,
            model_handler: ModelHandler,
            document_handler: Optional[DocumentHandler] = None,
            customer_profile_manager: Optional[CustomerProfileManager] = None,
            order_data_handler: Optional[OrderDataHandler] = None
    ):
        """
        Kh·ªüi t·∫°o agent service.

        Args:
            model_handler: Instance c·ªßa ModelHandler
            document_handler: Optional handler cho t√†i li·ªáu s·∫£n ph·∫©m
            customer_profile_manager: Optional manager cho customer profiles
            order_data_handler: Optional handler cho tra c·ª©u ƒë∆°n h√†ng
        """
        self.model = model_handler
        self.prompts = AgentPrompts()

        # T√≠nh nƒÉng m·ªü r·ªông
        self.doc_handler = document_handler
        self.customer_manager = customer_profile_manager
        self.order_handler = order_data_handler

        logger.info("Agent Service ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o")

        if self.doc_handler:
            logger.info("‚úÖ Document Handler: Enabled")
        if self.customer_manager:
            logger.info("‚úÖ Customer Profile Manager: Enabled")
        if self.order_handler:
            logger.info("‚úÖ Order Data Handler: Enabled")

    # ============================================
    # AGENT PH√ÇN LO·∫†I (CLASSIFICATION)
    # ============================================

    def phanloai_agent(
            self,
            user_input: str,
            conversation_history: Optional[List[Dict]] = None,
            customer_id: Optional[str] = None
    ) -> str:
        """
        Agent ph√¢n lo·∫°i √Ω ƒë·ªãnh kh√°ch h√†ng.

        Args:
            user_input: Tin nh·∫Øn t·ª´ user
            conversation_history: C√°c tin nh·∫Øn tr∆∞·ªõc ƒë√≥
            customer_id: Optional customer ID ƒë·ªÉ personalize

        Returns:
            Chu·ªói JSON v·ªõi k·∫øt qu·∫£ ph√¢n lo·∫°i
        """
        logger.info(f"PhanLoai ƒëang x·ª≠ l√Ω: {user_input[:50]}...")

        try:
            # Base prompt
            system_prompt = self.prompts.PHANLOAI

            # Th√™m customer context n·∫øu c√≥
            if customer_id and self.customer_manager:
                customer_context = self.customer_manager.get_customer_context(customer_id)
                system_prompt = get_customer_aware_prompt(system_prompt, customer_context)

            # Generate v·ªõi temperature th·∫•p
            response = self.model.generate(
                system_prompt=system_prompt,
                user_input=user_input,
                conversation_history=conversation_history,
                temperature=Config.PHANLOAI_TEMPERATURE,
                max_tokens=Config.PHANLOAI_MAX_TOKENS,
            )

            # Tr√≠ch xu·∫•t v√† validate JSON
            json_result = extract_json_from_response(response)

            logger.info(f"K·∫øt qu·∫£ PhanLoai: {json_result}")

            return json_result

        except Exception as e:
            logger.error(f"L·ªói PhanLoai: {e}", exc_info=True)
            return '{"json":"Unknown"}'

    # ============================================
    # AGENT T·∫†O ƒê∆†N H√ÄNG (ORDER CREATION)
    # ============================================

    def create_order_agent(
            self,
            user_input: str,
            conversation_history: Optional[List[Dict]] = None,
            customer_id: Optional[str] = None
    ) -> str:
        """
        Agent t·∫°o ƒë∆°n h√†ng v·ªõi customer awareness.

        Args:
            user_input: Tin nh·∫Øn t·ª´ user
            conversation_history: C√°c tin nh·∫Øn tr∆∞·ªõc
            customer_id: Optional customer ID

        Returns:
            Text response ho·∫∑c JSON (khi ƒë∆°n h√†ng ƒë∆∞·ª£c x√°c nh·∫≠n)
        """
        logger.info(f"CreateOrder ƒëang x·ª≠ l√Ω: {user_input[:50]}...")

        try:
            # Base prompt
            system_prompt = self.prompts.CREATE_ORDER

            # Th√™m customer context n·∫øu c√≥
            if customer_id and self.customer_manager:
                customer_context = self.customer_manager.get_customer_context(customer_id)
                system_prompt = get_customer_aware_prompt(system_prompt, customer_context)

            response = self.model.generate(
                system_prompt=system_prompt,
                user_input=user_input,
                conversation_history=conversation_history,
                temperature=Config.DEFAULT_TEMPERATURE,
                max_tokens=Config.DEFAULT_MAX_TOKENS,
            )

            logger.debug(f"ƒê·ªô d√†i response CreateOrder: {len(response)} k√Ω t·ª±")

            return response

        except Exception as e:
            logger.error(f"L·ªói CreateOrder: {e}", exc_info=True)
            return "Xin l·ªói, t√¥i g·∫∑p l·ªói khi x·ª≠ l√Ω ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i."

    # ============================================
    # AGENT T∆Ø V·∫§N (CONSULTING) - V·ªöI T√ÄI LI·ªÜU (FIXED)
    # ============================================

    def consulting_agent(
            self,
            user_input: str,
            conversation_history: Optional[List[Dict]] = None,
            customer_id: Optional[str] = None
    ) -> str:
        """
        Agent t∆∞ v·∫•n v·ªõi kh·∫£ nƒÉng ƒë·ªçc t√†i li·ªáu s·∫£n ph·∫©m.

        Args:
            user_input: Tin nh·∫Øn t·ª´ user
            conversation_history: C√°c tin nh·∫Øn tr∆∞·ªõc
            customer_id: Optional customer ID

        Returns:
            Text response t∆∞ v·∫•n
        """
        logger.info(f"Consulting ƒëang x·ª≠ l√Ω: {user_input[:50]}...")

        try:
            # Base prompt
            system_prompt = self.prompts.CONSULTING

            # ‚úÖ FIXED: Th√™m th√¥ng tin t·ª´ T·∫§T C·∫¢ documents (kh√¥ng ch·ªâ products)
            if self.doc_handler:
                relevant_info = ""
                
                # 1. T√¨m trong T·∫§T C·∫¢ t√†i li·ªáu (TXT, PDF, etc.)
                doc_results = self.doc_handler.search_in_documents(user_input, limit=3)
                
                if doc_results:
                    relevant_info += "\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
                    relevant_info += "üìö TH√îNG TIN T·ª™ T√ÄI LI·ªÜU:\n"
                    relevant_info += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
                    
                    for result in doc_results:
                        relevant_info += f"\n[{result['filename']}]\n"
                        relevant_info += f"{result['snippet']}\n"
                        relevant_info += f"(Relevance: {result['relevance']} l·∫ßn xu·∫•t hi·ªán)\n"
                    
                    logger.info(f"‚úÖ T√¨m th·∫•y {len(doc_results)} t√†i li·ªáu li√™n quan")
                
                # 2. T√¨m s·∫£n ph·∫©m trong catalog (JSON/CSV)
                products = self.doc_handler.search_products(user_input, limit=3)
                
                if products:
                    relevant_info += "\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
                    relevant_info += "üè∑Ô∏è TH√îNG TIN S·∫¢N PH·∫®M:\n"
                    relevant_info += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
                    
                    for p in products:
                        relevant_info += f"\nüì¶ {p.get('name', p.get('id'))}:\n"
                        
                        # Ch·ªâ hi·ªÉn th·ªã c√°c fields quan tr·ªçng
                        important_fields = ['type', 'color', 'price', 'description', 'weights']
                        for field in important_fields:
                            if field in p:
                                relevant_info += f"   ‚Ä¢ {field}: {p[field]}\n"
                    
                    logger.info(f"‚úÖ T√¨m th·∫•y {len(products)} s·∫£n ph·∫©m li√™n quan")
                
                # 3. Th√™m v√†o system prompt
                if relevant_info:
                    system_prompt += relevant_info
                    logger.debug(f"üìù ƒê√£ th√™m {len(relevant_info)} k√Ω t·ª± context v√†o prompt")
                else:
                    logger.warning("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y th√¥ng tin li√™n quan trong documents")

            # Th√™m customer context n·∫øu c√≥
            if customer_id and self.customer_manager:
                customer_context = self.customer_manager.get_customer_context(customer_id)
                system_prompt = get_customer_aware_prompt(system_prompt, customer_context)

            response = self.model.generate(
                system_prompt=system_prompt,
                user_input=user_input,
                conversation_history=conversation_history,
                temperature=Config.DEFAULT_TEMPERATURE,
                max_tokens=Config.DEFAULT_MAX_TOKENS,
            )

            logger.debug(f"ƒê·ªô d√†i response Consulting: {len(response)} k√Ω t·ª±")

            return response

        except Exception as e:
            logger.error(f"L·ªói Consulting: {e}", exc_info=True)
            return "Xin l·ªói, t√¥i g·∫∑p l·ªói khi t∆∞ v·∫•n. Vui l√≤ng h·ªèi l·∫°i."

    # ============================================
    # AGENT KI·ªÇM TRA ƒê∆†N H√ÄNG (M·ªöI)
    # ============================================

    def check_order_agent(
            self,
            user_input: str,
            conversation_history: Optional[List[Dict]] = None,
            customer_id: Optional[str] = None
    ) -> str:
        """
        Agent ki·ªÉm tra ƒë∆°n h√†ng t·ª´ sheets/csv.

        Args:
            user_input: Tin nh·∫Øn t·ª´ user (m√£ ƒë∆°n, SƒêT, t√™n)
            conversation_history: C√°c tin nh·∫Øn tr∆∞·ªõc
            customer_id: Optional customer ID

        Returns:
            Th√¥ng tin ƒë∆°n h√†ng
        """
        logger.info(f"CheckOrder ƒëang x·ª≠ l√Ω: {user_input[:50]}...")

        try:
            # N·∫øu kh√¥ng c√≥ order handler, tr·∫£ v·ªÅ th√¥ng b√°o
            if not self.order_handler:
                return "Xin l·ªói, t√≠nh nƒÉng tra c·ª©u ƒë∆°n h√†ng ch∆∞a ƒë∆∞·ª£c k√≠ch ho·∫°t."

            # Base prompt
            system_prompt = CHECK_ORDER_PROMPT

            # T√¨m ki·∫øm ƒë∆°n h√†ng trong database
            # Th·ª≠ t√¨m theo m√£ ƒë∆°n tr∆∞·ªõc
            orders = self.order_handler.search_orders(order_code=user_input, limit=5)

            # N·∫øu kh√¥ng t√¨m th·∫•y, th·ª≠ t√¨m theo SƒêT
            if not orders and user_input.replace(' ', '').replace('-', '').isdigit():
                orders = self.order_handler.search_orders(phone=user_input, limit=5)

            # N·∫øu v·∫´n kh√¥ng t√¨m th·∫•y, th·ª≠ t√¨m theo t√™n
            if not orders:
                orders = self.order_handler.search_orders(customer_name=user_input, limit=5)

            # Th√™m k·∫øt qu·∫£ t√¨m ki·∫øm v√†o prompt
            if orders:
                search_results = "\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
                search_results += "K·∫æT QU·∫¢ T√åM KI·∫æM ƒê∆†N H√ÄNG:\n"
                search_results += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
                
                for order in orders:
                    search_results += self.order_handler.format_order_info(order) + "\n"

                system_prompt += search_results
                
                logger.info(f"‚úÖ T√¨m th·∫•y {len(orders)} ƒë∆°n h√†ng")
            else:
                system_prompt += "\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
                system_prompt += "‚ö†Ô∏è KH√îNG T√åM TH·∫§Y ƒê∆†N H√ÄNG ph√π h·ª£p v·ªõi th√¥ng tin tra c·ª©u.\n"
                system_prompt += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
                
                logger.warning(f"‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng cho: {user_input[:50]}")

            # Th√™m customer context n·∫øu c√≥
            if customer_id and self.customer_manager:
                customer_context = self.customer_manager.get_customer_context(customer_id)
                system_prompt = get_customer_aware_prompt(system_prompt, customer_context)

            response = self.model.generate(
                system_prompt=system_prompt,
                user_input=user_input,
                conversation_history=conversation_history,
                temperature=Config.DEFAULT_TEMPERATURE,
                max_tokens=Config.DEFAULT_MAX_TOKENS,
            )

            logger.debug(f"ƒê·ªô d√†i response CheckOrder: {len(response)} k√Ω t·ª±")

            return response

        except Exception as e:
            logger.error(f"L·ªói CheckOrder: {e}", exc_info=True)
            return "Xin l·ªói, t√¥i g·∫∑p l·ªói khi tra c·ª©u ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i."

    # ============================================
    # BATCH PROCESSING
    # ============================================

    def batch_process(
            self,
            inputs: List[str],
            agent_type: str = "consulting"
    ) -> List[str]:
        """
        Batch processing cho nhi·ªÅu inputs c√πng l√∫c.

        L∆∞u √Ω: Kh√¥ng s·ª≠ d·ª•ng l·ªãch s·ª≠ h·ªôi tho·∫°i v√† customer context.

        Args:
            inputs: List c√°c chu·ªói user input
            agent_type: Agent ƒë·ªÉ s·ª≠ d·ª•ng

        Returns:
            List c√°c responses
        """
        logger.info(f"Batch processing {len(inputs)} inputs v·ªõi agent: {agent_type}")

        # Map agent type sang system prompt
        prompt_map = {
            "phanloai": self.prompts.PHANLOAI,
            "create_order": self.prompts.CREATE_ORDER,
            "consulting": self.prompts.CONSULTING,
            "check_order": CHECK_ORDER_PROMPT
        }

        system_prompt = prompt_map.get(agent_type, self.prompts.CONSULTING)

        try:
            # S·ª≠ d·ª•ng batch generation
            outputs = self.model.batch_generate(
                prompts=inputs,
                system_prompt=system_prompt
            )

            # Post-process cho agent phanloai
            if agent_type == "phanloai":
                outputs = [extract_json_from_response(out) for out in outputs]

            logger.info(f"Batch processing ho√†n t·∫•t: {len(outputs)} outputs")

            return outputs

        except Exception as e:
            logger.error(f"L·ªói batch processing: {e}", exc_info=True)
            return ["L·ªói x·ª≠ l√Ω"] * len(inputs)